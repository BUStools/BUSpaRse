---
title: "Converting BUS format into sparse matrix"
author: "Lambda Moses"
date: "`r Sys.Date()`"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Converting BUS format into sparse matrix}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction
The [Barcode, UMI, Set (BUS) format](https://www.biorxiv.org/content/early/2018/11/21/472571) is a new way to represent pseudoalignments of reads from RNA-seq. Files of this format can be efficiently generated by the command line tool [`kallisto bus`](https://pachterlab.github.io/kallisto/manual). With `kallisto bus` and this package, we go from the fastq files to the sparse matrix used for downstream analysis such as with Seurat within half an hour, while CellRanger would take hours. 

In this vignette, we convert an 10x 1:1 mouse and human cell mixture dataset from the BUS format to a sparse matrix. To see how the BUS format can be generated from fastq file, see [the website of this package](https://bustools.github.io/BUS_notebooks_R/index.html).

## Download the dataset
```{r, message=FALSE}
# The dataset package
library(TENxhgmmBUS)
library(BUSpaRse)
library(Matrix)
```

```{r}
download_hgmm(".", dataset = "hgmm100")
```

## Convert to sparse matrix
First, we map transcripts, as in the `kallisto` index, to the corresponding genes. 
```{r}
tr2g <- transcript2gene(c("Homo sapiens", "Mus musculus"),
                         kallisto_out_path = "./out_hgmm100")
```

```{r}
head(tr2g)
```

Then we map the equivalence class to genes. This gives us a list that maps each equivalence class to genes it's compatible to.
```{r}
genes <- EC2gene(tr2g, "./out_hgmm100", ncores = 1, verbose = FALSE)
```

```{r}
head(genes)
```

```{r}
tail(genes)
```

Finally, we can make the sparse matrix.
```{r}
res_mat <- make_sparse_matrix("./out_hgmm100/output.sorted.txt",
                               genes = genes, est_ncells = 3e5, 
                               est_ngenes = nrow(tr2g))
```

## Remove empty droplets
Here we have a sparse matrix with genes in rows and cells in columns.
```{r}
dim(res_mat)
```

This dataset should only have about 100 cells, but here we get over 100,000. In fact, most of the barcodes correspond to empty droplets; they can be removed by filtering out barcodes with too few UMI.

```{r}
tot_counts <- Matrix::colSums(res_mat)
res_mat <- res_mat[,tot_counts > 500]
dim(res_mat)
```

```{r}
hist(Matrix::colSums(res_mat), breaks = 30, 
     main = "Histogram of number of UMIs per barcode")
```

Then this sparse matrix can be used in Seurat for downstream analysis.
